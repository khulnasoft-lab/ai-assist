---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: model-triton
  labels:
    app: model-triton
spec:
  replicas: 1
  selector:
    matchLabels:
      app: model-triton
  template:
    metadata:
      labels:
        app: model-triton
    spec:
      imagePullSecrets:
        - name: gitlab-registry
      containers:
        - name: triton
          image: moyix/triton_with_ft:22.09
          ports:
            - containerPort: 8000
            - containerPort: 8001
            - containerPort: 8002
          env:
            - name: MODEL
              value: "fastertransformer"
            - name: MODEL_DIR
              value: "/model" # Use this path as it's hardcoded in Triton configs
            - name: TRITON_BIN
              value: "/opt/tritonserver/bin/tritonserver"
          command: ["/bin/bash", "-c", "--"]
          args:
            - "CUDA_VISIBLE_DEVICES=0 $(TRITON_BIN) --model-repository=$(MODEL_DIR) --model-control-mode=explicit --load-model=$(MODEL)"
          volumeMounts:
            - name: model-nfc-pvc-volume
              mountPath: /model
              readOnly: true
          resources:
            limits:
              nvidia.com/gpu: "1"
      volumes:
        - name: model-nfc-pvc-volume
          persistentVolumeClaim:
            claimName: model-nfs-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: model-k8s-triton
  labels:
    app: model-triton
spec:
  type: ClusterIP
  ports:
    - name: api
      port: 8080
      targetPort: 8001
    - name: metrics
      port: 8082
      targetPort: 8002
  selector:
    app: model-triton
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: model-triton
  labels:
    release: prometheus
spec:
  endpoints:
    - interval: 30s
      port: metrics
  selector:
    matchLabels:
      app: model-triton
